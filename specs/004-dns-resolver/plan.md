# Implementation Plan: Azure DNS Private Resolver for Core Infrastructure

**Branch**: `004-dns-resolver` | **Date**: 2026-01-04 | **Spec**: [spec.md](spec.md)

## Summary

Deploy Azure DNS Private Resolver (inbound endpoint) into the core shared services VNet so P2S/WSL clients resolve private endpoints to private IPs automatically. Single resolver, single inbound endpoint (10.1.0.64/27 subnet), queries private DNS zones linked to shared VNet.

## Technical Context

**Language/Platform**: Bicep 0.25+ (Azure Resource Manager templates)  
**Primary Dependencies**: Core VNet (001-vwan-core), existing private DNS zones  
**Deployment Scope**: Subscription-level (resource group scoped module)  
**Testing**: Manual nslookup/dig, Azure CLI queries, curl to private endpoints  
**Target Audience**: DevOps, platform engineers  
**Performance**: <100ms DNS queries, handles thousands of concurrent clients  
**Constraints**: Inbound subnet requires service delegation; no outbound endpoint in MVP  
**Scale/Scope**: Single resolver instance, one inbound endpoint, ~50 lines Bicep

## Constitution Check

✅ **Infrastructure as Code (IaC)**: Compliant - Full Bicep template, no manual portal changes.  
✅ **Hub-Spoke Architecture**: Compliant - Resolver in hub shared services, supports all spokes.  
✅ **Resource Organization**: Compliant - Deployed in rg-ai-core, tagged per constitution.  
✅ **Security and Secrets**: Compliant - No secrets involved; DNS queries from authorized VPN clients only.  
✅ **Deployment Standards**: Compliant - Idempotent Bicep, documented, testable.  
✅ **Lab Modularity**: Compliant - Resolver is shared service, independent of spoke deployments.  
✅ **Documentation**: Compliant - Will integrate into docs/core-infrastructure/ per standards.

**Gate Status**: ✅ PASS - No constitution violations.

## Project Structure

### Documentation (this feature)

```
specs/004-dns-resolver/
├── plan.md              # This file
├── spec.md              # Feature specification
├── research.md          # DNS resolver research & design decisions
├── data-model.md        # Resolver entities, subnet, endpoint data structures
├── quickstart.md        # Operational deployment & validation guide
├── contracts/           # Deployment & validation contracts
│   ├── deployment-contract.md
│   └── validation-contract.md
└── checklists/
    └── requirements.md  # Specification quality checklist
```

### Source Code (bicep/)

```
bicep/
├── modules/dns-resolver.bicep     # Created; resolver + inbound endpoint module
├── main.bicep                     # Updated; integrated resolver into core
├── main.parameters.example.json   # Updated; added resolver params
└── main.parameters.schema.json    # Updated; resolver param schema
```

**Structure Decision**: Module integrates into existing core infrastructure template (main.bicep). No separate deployment; part of standard core deployment workflow.

## Phase 0: Research (Planned)

Research topics to document:
1. Azure DNS Private Resolver architecture and inbound endpoint behavior.
2. Private DNS zone resolution flow when resolver is in linked VNet.
3. P2S client routing to resolver inbound endpoint IP via vHub.
4. Idempotency and re-deployment safety.
5. Validation and troubleshooting approaches.
6. Fallback DNS behavior (public queries via resolver).

Output: [research.md](research.md)

## Phase 1: Design (Planned)

### Data Model ([data-model.md](data-model.md))
- Resolver entity: Properties, lifecycle, outputs.
- Inbound endpoint: Subnet, IP allocation, reachability.
- Inbound subnet: Address range, delegation, networking.
- Routing: P2S → vHub → Shared VNet → Resolver IP.

### Contracts ([contracts/](contracts/))
- **Deployment Contract**: Bicep inputs, outputs, dependencies, side effects.
- **Validation Contract**: Tests for resolver functionality (DNS resolution, connectivity).

### Quickstart ([quickstart.md](quickstart.md))
- Deploy resolver via core infrastructure deployment.
- Obtain inbound endpoint IP from outputs.
- Validate resolver answers DNS queries for private zones.
- Update WSL/client configuration to use resolver IP.
- Troubleshoot common issues.

### Agent Context
- Update GitHub Copilot context with Bicep and Azure DNS resolver details.

## Phase 2: Implementation Tasks (Planned)

**Note**: Tasks will be generated by `/speckit.tasks` command.

Expected task breakdown:
- **Phase 1 (Setup)**: 2–3 tasks (branch verification, validation test structure).
- **Phase 2 (Deployment)**: 5–8 tasks (deploy resolver, verify resources, obtain IP).
- **Phase 3 (Validation)**: 10–15 tasks (DNS query tests, connectivity checks, edge cases).
- **Phase 4 (Integration)**: 5–10 tasks (update WSL templates, test WSL config with resolver).
- **Phase 5 (Documentation)**: 10–15 tasks (operational runbook, troubleshooting, examples).
- **Phase 6 (Polish)**: 5–10 tasks (code quality, testing, integration tests).

**Total Estimated Tasks**: 40–60

## Success Validation

After all tasks complete, the feature is successful if:

- ✅ **SC-001**: Bicep deployment completes; resolver and inbound endpoint created.
- ✅ **SC-002**: Inbound endpoint IP reachable via nslookup from P2S client pool.
- ✅ **SC-003**: Private zone queries return private IPs (10.x.x.x).
- ✅ **SC-004**: Public domain queries work via resolver.
- ✅ **SC-005**: HTTPS to private endpoints via resolver IP works.
- ✅ **SC-006**: Resolver resolves correctly from WSL when configured with IP.
- ✅ **SC-007**: Re-deployment is safe (idempotent).
- ✅ **SC-008**: Documentation enables independent troubleshooting.

## Next Steps

1. Generate [research.md](research.md) with DNS resolver design decisions.
2. Create [data-model.md](data-model.md) documenting resolver, endpoint, subnet structures.
3. Define [contracts/](contracts/) for deployment and validation.
4. Create [quickstart.md](quickstart.md) for operational guidance.
5. Generate [tasks.md](tasks.md) with implementation tasks.
6. Execute Phase 1 & 2 to validate deployment.
7. Update WSL feature (003) to use resolver IP instead of manual configuration.

---

**Status**: Specification phase ready for Phase 0 research.
