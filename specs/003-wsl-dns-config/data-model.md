# Phase 1: Data Model - WSL DNS Configuration Files

**Created**: 2026-01-02  
**Purpose**: Document the structure and relationships of configuration files involved in WSL DNS setup

## Configuration File Entities

### 1. /etc/wsl.conf

**Purpose**: Controls WSL instance behavior and system-level settings

**Location**: `/etc/wsl.conf` (created if doesn't exist)

**Format**: INI-style configuration file

**Structure**:
```ini
[network]
generateResolvConf = false
```

**Fields**:
| Section | Key | Type | Description | Valid Values |
|---------|-----|------|-------------|--------------|
| network | generateResolvConf | boolean | Controls automatic /etc/resolv.conf generation | `true`, `false` |

**Relationships**:
- **Affects**: `/etc/resolv.conf` generation behavior
- **Read by**: WSL init process on distribution startup
- **Modified by**: `configure-wsl-dns.sh` script

**Lifecycle**:
- Created once per WSL distribution
- Persists across WSL restarts
- Survives Windows reboots
- Does NOT survive WSL distribution reset/reinstall

**Validation Rules**:
- Must be readable by WSL init process
- `generateResolvConf` must be explicitly `false` to prevent auto-generation
- Changes require WSL instance restart to take effect

**Example (Complete)**:
```ini
# WSL Configuration for Azure Private DNS
# Generated by: configure-wsl-dns.sh
# Date: 2026-01-02

[network]
# Disable automatic /etc/resolv.conf generation
# This allows manual DNS configuration for Azure private DNS zones
generateResolvConf = false
```

### 2. /etc/resolv.conf

**Purpose**: Specifies DNS resolver configuration for Linux name resolution

**Location**: `/etc/resolv.conf`

**Format**: Plain text, one directive per line

**Structure**:
```
nameserver <ip-address>
search <domain-list>
options <option-list>
```

**Fields**:
| Directive | Type | Description | Example |
|-----------|------|-------------|---------|
| nameserver | IP address | DNS server to query | `nameserver 168.63.129.16` |
| search | Domain list | Domains to append to unqualified names | `search azure.internal` |
| options | Option list | Resolver options (timeout, attempts, etc.) | `options timeout:2 attempts:3` |

**Relationships**:
- **Generated by**: WSL (if `generateResolvConf = true`) or manual configuration
- **Read by**: System resolver library (glibc, musl)
- **Used by**: All DNS queries from WSL (nslookup, curl, az cli, etc.)
- **Depends on**: `/etc/wsl.conf` setting `generateResolvConf = false` to prevent overwrite

**Lifecycle**:
- Overwritten on every WSL start if `generateResolvConf = true`
- Persists between commands if `generateResolvConf = false`
- Changes take effect immediately (no restart required once wsl.conf configured)

**Validation Rules**:
- Must contain at least one `nameserver` directive
- Maximum 3 nameserver directives (Linux resolver limit)
- Nameserver IP addresses must be reachable from WSL network
- File must be readable by all users (chmod 644)

**Example (Azure Private DNS Configuration)**:
```
# DNS Configuration for Azure Private DNS Zones
# Generated by: configure-wsl-dns.sh
# Date: 2026-01-02
# VPN Required: Azure VPN must be connected for private DNS resolution

# Primary: DNS Private Resolver (required for private DNS zones)
# Get resolver IP from feature 004 deployment: dnsResolverInboundIp
nameserver 10.1.0.68

# Fallback: Google DNS (used when resolver unavailable or public domains)
nameserver 8.8.8.8

# Search domain: Azure internal domain for short-name resolution
search x5ksal5ehxruph3istx2szuwhf.ux.internal.cloudapp.net
```

### 3. Configuration Backup Files

**Purpose**: Preserve original configuration for rollback capability

**Location Pattern**: 
- `/etc/wsl.conf.backup.<timestamp>`
- `/etc/resolv.conf.backup.<timestamp>`

**Format**: Same as original files

**Timestamp Format**: `YYYYMMDD-HHMMSS` (e.g., `20260102-153045`)

**Relationships**:
- **Created by**: `configure-wsl-dns.sh` before modifying originals
- **Used by**: Manual rollback if DNS configuration causes issues

**Lifecycle**:
- Created once per script execution
- Never automatically deleted
- Can accumulate over time (manual cleanup recommended)

**Example Filenames**:
```
/etc/wsl.conf.backup.20260102-153045
/etc/resolv.conf.backup.20260102-153045
/etc/resolv.conf.backup.20260105-092314
```

## Configuration State Machine

```
┌─────────────────────────────────────────────────────────────┐
│ Initial State: Fresh WSL Installation                       │
│ - /etc/wsl.conf: May not exist or has default settings     │
│ - /etc/resolv.conf: Auto-generated from Windows DNS        │
│ - Private DNS: Resolves to public IPs or fails             │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ Run configure-wsl-dns.sh
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Configured State: WSL DNS Configured                        │
│ - /etc/wsl.conf: generateResolvConf = false                │
│ - /etc/resolv.conf: nameserver 168.63.129.16               │
│ - Backups: Original files saved with timestamp             │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ wsl --shutdown && restart
                            ▼
┌─────────────────────────────────────────────────────────────┐
│ Active State: Private DNS Resolution Working                │
│ - WSL reads wsl.conf on startup                            │
│ - resolv.conf NOT overwritten (generateResolvConf=false)   │
│ - Private DNS queries route to 168.63.129.16               │
│ - Private FQDNs resolve to private IPs                     │
└─────────────────────────────────────────────────────────────┘
```

## DNS Resolution Data Flow

```
┌──────────────────┐
│ Application      │  (e.g., az acr login, curl, nslookup)
│ (WSL)            │
└────────┬─────────┘
         │ 1. DNS Query: acraihubk2lydtz5uba3q.azurecr.io
         ▼
┌──────────────────────────────────────────────────────────────┐
│ System Resolver (/etc/resolv.conf)                          │
│ - Reads nameserver list                                     │
│ - Appends search domains if needed                          │
└────────┬─────────────────────────────────────────────────────┘
         │ 2. Query sent to: 168.63.129.16
         ▼
┌──────────────────────────────────────────────────────────────┐
│ Azure VPN Tunnel                                             │
│ - Routes traffic to Azure virtual network                   │
└────────┬─────────────────────────────────────────────────────┘
         │ 3. Query reaches Azure network
         ▼
┌──────────────────────────────────────────────────────────────┐
│ Azure DNS Resolver (168.63.129.16)                          │
│ - Checks private DNS zones linked to VNet                   │
│ - Finds: privatelink.azurecr.io                             │
│ - Locates A record: acraihubk2lydtz5uba3q → 10.1.0.5        │
└────────┬─────────────────────────────────────────────────────┘
         │ 4. DNS Response: 10.1.0.5 (private IP)
         ▼
┌──────────────────┐
│ Application      │  Connects to 10.1.0.5 via VPN tunnel
│ (WSL)            │  Private endpoint accessible
└──────────────────┘
```

## File Dependency Graph

```
/etc/wsl.conf (generateResolvConf = false)
    │
    │ Controls
    ▼
/etc/resolv.conf (nameserver 168.63.129.16)
    │
    │ Used by
    ▼
System Resolver (glibc/musl)
    │
    │ Used by
    ▼
All DNS Queries (az cli, curl, nslookup, etc.)
    │
    │ Routed via
    ▼
Azure VPN Tunnel
    │
    │ Reaches
    ▼
Azure DNS Resolver (168.63.129.16)
    │
    │ Queries
    ▼
Private DNS Zones (privatelink.azurecr.io, etc.)
    │
    │ Returns
    ▼
Private Endpoint IP Address (10.x.x.x)
```

## Configuration Validation Data

| Check | File | Validation Logic | Expected Result |
|-------|------|------------------|-----------------|
| WSL.conf exists | `/etc/wsl.conf` | `test -f /etc/wsl.conf` | Exit 0 (file exists) |
| Auto-gen disabled | `/etc/wsl.conf` | `grep -q "generateResolvConf = false" /etc/wsl.conf` | Exit 0 (match found) |
| Resolv.conf exists | `/etc/resolv.conf` | `test -f /etc/resolv.conf` | Exit 0 (file exists) |
| Azure DNS present | `/etc/resolv.conf` | `grep -q "168.63.129.16" /etc/resolv.conf` | Exit 0 (match found) |
| DNS reachable | Network | `ping -c 1 168.63.129.16` | Exit 0 (ping success) |
| Private DNS works | DNS | `nslookup acr*.azurecr.io \| grep "10\."` | Match found (private IP) |
| Connectivity works | Network | `curl -s -o /dev/null -w "%{http_code}" https://acr*.azurecr.io/v2/` | 401 or 200 (not 403) |

## Error States and Recovery

| Error State | Cause | Detection | Recovery |
|-------------|-------|-----------|----------|
| Auto-generation still active | `generateResolvConf = true` or not set | resolv.conf changes after restart | Set to `false`, restart WSL |
| Azure DNS unreachable | VPN disconnected | `ping 168.63.129.16` fails | Connect VPN, verify tunnel |
| Public IP resolution | Private DNS not working | nslookup returns 20.x.x.x | Check DNS zone links, VPN routing |
| Permission denied | Missing sudo | Script fails to write files | Run with sudo or fix permissions |
| Backup conflicts | Multiple script runs | Many backup files accumulate | Manual cleanup of old backups |

## Summary

The WSL DNS configuration involves two primary files:
1. **`/etc/wsl.conf`**: Controls WSL behavior (disable DNS auto-generation)
2. **`/etc/resolv.conf`**: Specifies DNS resolver (Azure DNS 168.63.129.16)

These files work together to enable Azure private DNS resolution from WSL over VPN. The configuration is persistent, idempotent, and includes backup mechanisms for safety. All DNS queries flow through Azure DNS resolver, which has knowledge of private DNS zones linked to the virtual network, enabling resolution of private endpoints to their internal IP addresses.
