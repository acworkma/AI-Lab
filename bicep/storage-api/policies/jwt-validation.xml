<!--
    JWT Validation Policy for Storage API
    
    Validates OAuth 2.0 bearer tokens from Entra ID
    Tenant: MngEnvMCAP818246.onmicrosoft.com
    App Registration: apim-ai-lab-0115-devportal
-->
<policies>
    <inbound>
        <base />
        <!-- Validate JWT token from Entra ID -->
        <validate-jwt header-name="Authorization" 
                      failed-validation-httpcode="401" 
                      failed-validation-error-message="Unauthorized. Access token is missing or invalid."
                      require-expiration-time="true"
                      require-signed-tokens="true">
            <!-- Use OpenID Connect discovery for key retrieval -->
            <openid-config url="https://login.microsoftonline.com/38c1a7b0-f16b-45fd-a528-87d8720e868e/v2.0/.well-known/openid-configuration" />
            <!-- Allowed audiences (App Registration Client ID) -->
            <audiences>
                <audience>6cb63aba-6d0d-4f06-957e-c584fdeb23d7</audience>
                <audience>api://6cb63aba-6d0d-4f06-957e-c584fdeb23d7</audience>
            </audiences>
            <!-- Token issuer validation -->
            <issuers>
                <issuer>https://login.microsoftonline.com/38c1a7b0-f16b-45fd-a528-87d8720e868e/v2.0</issuer>
                <issuer>https://sts.windows.net/38c1a7b0-f16b-45fd-a528-87d8720e868e/</issuer>
            </issuers>
        </validate-jwt>
    </inbound>
    <backend>
        <base />
    </backend>
    <outbound>
        <base />
    </outbound>
    <on-error>
        <base />
        <!-- Return structured error for JWT validation failures -->
        <choose>
            <when condition="@(context.LastError.Source == &quot;validate-jwt&quot;)">
                <return-response>
                    <set-status code="401" reason="Unauthorized" />
                    <set-header name="Content-Type" exists-action="override">
                        <value>application/json</value>
                    </set-header>
                    <set-body>@{
                        return new JObject(
                            new JProperty("error", new JObject(
                                new JProperty("code", "Unauthorized"),
                                new JProperty("message", context.LastError.Message)
                            ))
                        ).ToString();
                    }</set-body>
                </return-response>
            </when>
        </choose>
    </on-error>
</policies>
